{% extends "base.html" %}
{% block title %}{{ property.name }} Details{% endblock %}

{% block content %}
<h1 class="mb-4">{{ property.name }}</h1>
<p>Address: {{ property.address }}</p>

<h2 class="mt-4 mb-3">Units</h2>
<table class="table">
    <thead>
        <tr>
            <th>Unit Number</th>
            <th>Renter's Name</th>
            <th>Phone Number</th>
            <th>Email</th>
            <th>Rent Amount</th>
            <th>Rent Due Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for unit in property.units %}
        <tr>
            <td>{{ unit.unit_number }}</td>
            <td>{{ unit.renter_name }}</td>
            <td>{{ unit.phone_number }}</td>
            <td>{{ unit.email }}</td>
            <td>${{ unit.rent_amount }}</td>
            <td>{{ unit.rent_due_date.strftime('%B %d, %Y') }}</td>
            <td>
                <a href="{{ url_for('edit_unit', unit_id=unit.id) }}" class="btn btn-sm btn-primary">Edit</a>
                <form action="{{ url_for('delete_unit', unit_id=unit.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Are you sure you want to delete this unit?');">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{{ url_for('add_unit', property_id=property.id) }}" class="btn btn-primary mb-4">Add Unit</a>

<h2 class="mt-4 mb-3">Add Payable</h2>
<form method="POST" action="{{ url_for('property_detail', property_id=property.id) }}" class="mb-4">
    <input type="hidden" name="add_payable" value="1">
    <div class="row g-3 align-items-end">
        <div class="col-md">
            <label for="description" class="form-label">Description</label>
            <input type="text" class="form-control" id="description" name="description" required>
        </div>
        <div class="col-md">
            <label for="amount" class="form-label">Amount</label>
            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
        </div>
        <div class="col-md">
            <label for="due_date" class="form-label">Due Date</label>
            <input type="text" class="form-control datepicker" id="due_date" name="due_date" required>
        </div>
        <div class="col-md">
            <label for="vendor" class="form-label">Vendor</label>
            <input type="text" class="form-control" id="vendor" name="vendor" required autocomplete="off">
            <div id="vendorSuggestions" class="dropdown-menu"></div>
        </div>
        <div class="col-md">
            <label for="category" class="form-label">Category</label>
            <select class="form-select" id="category" name="category" required>
                <option value="" selected disabled>Choose a category</option>
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md">
            <button type="submit" class="btn btn-primary">Add Payable</button>
        </div>
    </div>
</form>

<h2 class="mt-4 mb-3">Payables</h2>
<table class="table">
    <thead>
        <tr>
            <th>Description</th>
            <th>Amount</th>
            <th>Due Date</th>
            <th>Category</th>
            <th>Vendor</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for payable in property.payables %}
        <tr>
            <td>{{ payable.description }}</td>
            <td>${{ payable.amount }}</td>
            <td>{{ payable.due_date.strftime('%B %d, %Y') }}</td>
            <td>{{ payable.category }}</td>
            <td>{{ payable.vendor }}</td>
            <td>
                <button type="button" class="btn btn-sm btn-success mark-as-paid-btn"
                    data-payable-id="{{ payable.id }}">
                    Mark as Paid
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2 class="mt-4 mb-3">Add Expense</h2>
<form method="POST" action="{{ url_for('property_detail', property_id=property.id) }}" class="mb-4">
    <input type="hidden" name="add_expense" value="1">
    <div class="row g-3 align-items-end">
        <div class="col-md">
            <label for="description" class="form-label">Description</label>
            <input type="text" class="form-control" id="description" name="description" required>
        </div>
        <div class="col-md">
            <label for="amount" class="form-label">Amount</label>
            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
        </div>
        <div class="col-md">
            <label for="date_paid" class="form-label">Date Paid</label>
            <input type="text" class="form-control datepicker" id="date_paid" name="date_paid" required>
        </div>
        <div class="col-md">
            <label for="vendor" class="form-label">Vendor</label>
            <input type="text" class="form-control" id="vendor" name="vendor" required autocomplete="off">
            <div id="vendorSuggestions" class="dropdown-menu"></div>
        </div>
        <div class="col-md">
            <label for="category" class="form-label">Category</label>
            <select class="form-select" id="category" name="category" required>
                <option value="" selected disabled>Choose a category</option>
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md">
            <label for="payment_method_type" class="form-label">Payment Method</label>
            <select class="form-select payment_method_type" id="payment_method_type" name="payment_method_type"
                required>
                <option value="" selected disabled>Choose a method</option>
                {% for method in payment_method_types %}
                <option value="{{ method }}">{{ method }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md credit_card_field" style="display: none;">
            <label for="credit_card_id" class="form-label">Credit Card</label>
            <select class="form-select" id="credit_card_id" name="credit_card_id">
                <option value="" selected disabled>Choose a credit card</option>
                {% for card in credit_cards %}
                <option value="{{ card.id }}">{{ card.description }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md check_number_field" style="display: none;">
            <label for="check_number" class="form-label">Check Number</label>
            <input type="text" class="form-control" id="check_number" name="check_number">
        </div>
        <div class="col-md">
            <button type="submit" class="btn btn-primary">Add Expense</button>
        </div>
    </div>
</form>

<h2 class="mt-4 mb-3">Expenses</h2>
<table class="table">
    <thead>
        <tr>
            <th>Description</th>
            <th>Amount</th>
            <th>Date Paid</th>
            <th>Category</th>
            <th>Vendor</th>
            <th>Payment Method</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for expense in property.expenses %}
        <tr>
            <td>{{ expense.description }}</td>
            <td>${{ expense.amount }}</td>
            <td>{{ expense.date_paid.strftime('%B %d, %Y') }}</td>
            <td>{{ expense.category }}</td>
            <td>{{ expense.vendor }}</td>
            <td>
                {{ expense.payment_method_type }}
                {% if expense.payment_method_type == 'Credit Card' %}
                ({{ expense.card_type }} ending in {{ expense.card_last_four }})
                {% elif expense.payment_method_type == 'Check' %}
                (Check #{{ expense.check_number }})
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" class="btn btn-sm btn-primary">Edit</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Mark Payable as Paid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm" method="POST">
                    <div class="mb-3">
                        <label for="modal_payment_method_type" class="form-label">Payment Method</label>
                        <select class="form-select" id="modal_payment_method_type" name="payment_method_type" required>
                            <option value="" selected disabled>Choose a method</option>
                            {% for method in payment_method_types %}
                            <option value="{{ method }}">{{ method }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3" id="modal_credit_card_field" style="display: none;">
                        <label for="modal_credit_card_id" class="form-label">Credit Card</label>
                        <select class="form-select" id="modal_credit_card_id" name="credit_card_id">
                            <option value="" selected disabled>Choose a credit card</option>
                            {% for card in credit_cards %}
                            <option value="{{ card.id }}">{{ card.description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3" id="modal_check_number_field" style="display: none;">
                        <label for="modal_check_number" class="form-label">Check Number</label>
                        <input type="text" class="form-control" id="modal_check_number" name="check_number">
                    </div>
                    <div class="mb-3">
                        <label for="modal_date_paid" class="form-label">Date Paid</label>
                        <input type="text" class="form-control datepicker" id="modal_date_paid" name="date_paid"
                            required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitPaymentForm">Mark Paid</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize date pickers
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "F j, Y",
            allowInput: true
        });

        // Payment method handling for expense and payable forms
        const paymentMethodSelects = document.querySelectorAll('.payment_method_type');
        paymentMethodSelects.forEach(select => {
            const form = select.closest('form');
            const creditCardField = form.querySelector('.credit_card_field');
            const checkNumberField = form.querySelector('.check_number_field');

            select.addEventListener('change', function () {
                if (this.value === 'Credit Card') {
                    creditCardField.style.display = 'block';
                    checkNumberField.style.display = 'none';
                } else if (this.value === 'Check') {
                    creditCardField.style.display = 'none';
                    checkNumberField.style.display = 'block';
                } else {
                    creditCardField.style.display = 'none';
                    checkNumberField.style.display = 'none';
                }
            });
        });

        // Vendor suggestions
        const vendorInputs = document.querySelectorAll('input[name="vendor"]');
        vendorInputs.forEach(input => {
            const suggestionsList = input.nextElementSibling;

            input.addEventListener('input', function () {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    suggestionsList.innerHTML = '';
                    suggestionsList.style.display = 'none';
                    return;
                }

                fetch(`/vendor-suggestions?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsList.innerHTML = '';
                        data.forEach(vendor => {
                            const item = document.createElement('a');
                            item.classList.add('dropdown-item');
                            item.href = '#';
                            item.textContent = vendor;
                            item.addEventListener('click', function (e) {
                                e.preventDefault();
                                input.value = this.textContent;
                                suggestionsList.style.display = 'none';
                            });
                            suggestionsList.appendChild(item);
                        });
                        suggestionsList.style.display = data.length ? 'block' : 'none';
                    });
            });

            document.addEventListener('click', function (e) {
                if (e.target !== input && e.target !== suggestionsList) {
                    suggestionsList.style.display = 'none';
                }
            });
        });

        // Payable payment modal handling
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const paymentForm = document.getElementById('paymentForm');
        const modalPaymentMethodSelect = document.getElementById('modal_payment_method_type');
        const modalCreditCardField = document.getElementById('modal_credit_card_field');
        const modalCheckNumberField = document.getElementById('modal_check_number_field');

        modalPaymentMethodSelect.addEventListener('change', function () {
            if (this.value === 'Credit Card') {
                modalCreditCardField.style.display = 'block';
                modalCheckNumberField.style.display = 'none';
            } else if (this.value === 'Check') {
                modalCreditCardField.style.display = 'none';
                modalCheckNumberField.style.display = 'block';
            } else {
                modalCreditCardField.style.display = 'none';
                modalCheckNumberField.style.display = 'none';
            }
        });

        document.getElementById('submitPaymentForm').addEventListener('click', function (e) {
            e.preventDefault();
            if (paymentForm.checkValidity()) {
                paymentForm.submit();
            } else {
                paymentForm.reportValidity();
            }
        });

        // Handle "Mark as Paid" button clicks
        document.querySelectorAll('.mark-as-paid-btn').forEach(button => {
            button.addEventListener('click', function () {
                const payableId = this.getAttribute('data-payable-id');
                paymentForm.action = `/payable/${payableId}/mark-as-paid`;
                paymentModal.show();
            });
        });

        document.getElementById('submitPaymentForm').addEventListener('click', function () {
            paymentForm.submit();
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>
{% endblock %}